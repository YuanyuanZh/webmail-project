
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web Mail</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- bootstrap 3.0.2 -->
    <link href="/resources/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!--  -->
    <link href="/resources/css/bootstrap.progress-auto.css" rel="stylesheet" type="text/css" />
    <!-- font Awesome -->
    <link href="/resources/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Ionicons -->
    <!--<link href="/resources/css/ionicons.min.css" rel="stylesheet" type="text/css" />-->
    <!-- bootstrap wysihtml5 - text editor -->
    <!--<link href="/resources/css/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" rel="stylesheet" type="text/css" />-->
    <!-- iCheck for checkboxes and radio inputs -->
    <!--<link href="/resources/css/iCheck/minimal/blue.css" rel="stylesheet" type="text/css" />-->
    <!-- Theme style -->
    <link href="/resources/css/mail.css" rel="stylesheet" type="text/css" />
    <link href="/resources/css/mail-resp.css" rel="stylesheet" type="text/css" />

    <!-- favicon from https://dribbble.com/shots/1297277-Adline-Social-icons-Retouched?list=searches&tag=mail_icon&offset=11 -->
    <link rel="shortcut icon" href="/resources/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/resources/img/favicon.ico" type="image/x-icon">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body class="">


<div class="wrapper">
<aside class="left-side x-col">
    <div id="profile" class="profile column-header">
        <img src="/resources/img/avatar/avatar_2x.png" height="40" width="40" class="profile-avatar img-circle img-thumbnail" alt="Avatar" />
        <span class="profile-name"></span>

        <!--<div class="profile-dropdown dropdown" >
            <span class="glyphicon glyphicon-collapse-down dropdown-trigger" data-toggle="dropdown"></span>

            <ul class="dropdown-menu" role="menu">
                <li><a href="#">Foo</a></li>
                <li><a href="#">Bar</a></li>
            </ul>
        </div>-->
    </div>
    <div class="left-side-tabs">
        <ul class="nav nav-tabs nav-justified">
            <li role="presentation" class="active"><a href="#">Mail</a></li>
            <li role="presentation"><a href="/contacts">Contacts</a></li>
        </ul>
    </div>

    <div style="padding: 1.4em 1em;">
        <button class="btn btn-primary btn-block compose-btn btn-disabled" disabled="disabled"><i class="fa fa-pencil-square-o"></i>&nbsp;&nbsp; Compose</button>
    </div>

    <div style="padding: 0;">
        <ul id="mainMenu" class="nav nav-stacked mail-menu">
            <li id="folderInbox" class="active" data-name="inbox"><a href="#/mail/list/inbox"><i class="fa fa-inbox"></i> <span>Inbox</span>
                <!--<small class="badge pull-right bg-green">192</small>-->
            </a></li>
            <!--<li><a href="#"><i class="fa fa-archive"></i> <span>Sent</span></a></li>-->
            <li data-name="fav"><a href="#/mail/list/fav"><i class="fa fa-star-o"></i> <span>Starred</span></a></li>
            <!--<li><a href="#"><i class="fa fa-file-o"></i> <span>Drafts</span></a></li>-->
            <li data-name="trash"><a href="#"><i class="fa fa-trash"></i> <span>Trash</span></a></li>
        </ul>

        <!-- <h5 class="h5">TAGS</h5> -->
    </div>

    <div id="tbSystem" class="toolbar toolbar-bottom">
        <div class="btn-group" style="position: absolute; bottom: 1.5em; left: 50%; margin-left: -34px;">
            <button class="btn btn-default logout-btn"><i class="fa fa-power-off"></i></button>
            <button class="btn btn-default settings-btn"><i class="fa fa-cog"></i></button>
        </div>
    </div>

</aside>

<!-- Mail list -->
<aside id="maillist" class="second-left-side x-col">

    <div class="column-header">
        <!--<div class="search-box pull-right">-->
            <!--<input class="" placeholder="Search Mail..." type="text" />-->
            <!--<span class="search-icon"><i class="fa fa-search"></i></span>-->
        <!--</div>-->

        <h2 id="lblFolderName" class="folder-name">Inbox</h2>
    </div>

    <header class="toolbar">

        <div class="select-btn btn-group">
            <button class="select-all-btn btn btn-default  btn-sm">
                <i class="fa fa-square-o"></i>
            </button>
            <button type="button" class="btn btn-default  btn-sm dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="select-all-menu"><a href="#">All</a></li>
                <li class="select-none-menu"><a href="#">None</a></li>
                <li class="select-read-menu"><a href="#">Read</a></li>
                <li class="select-unread-menu"><a href="#">Unread</a></li>
                <li class="select-star-menu"><a href="#">Starred</a></li>
                <li class="select-unstar-menu"><a href="#">Unstarred</a></li>
            </ul>
        </div>

        <div class="btn-group">
            <!-- <button class="btn btn-default"><i class="fa fa-refresh"></i></button> -->
            <button class="btn btn-default refresh-btn  btn-sm"><i class="fa fa-refresh"></i></button>
        </div>
        <div class="btn-group">
            <!--<button type="button" class="btn btn-default"><i class="fa fa-archive"></i></button>-->
            <!--<button type="button" class="btn btn-default"><i class="fa fa-info-circle"></i></button>-->
            <button type="button" class="btn btn-default delete-btn  btn-sm"><i class="fa fa-trash"></i></button>
        </div>

        <div class="moveto-btn btn-group">
            <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown"
                    title="Move to">
                <i class="fa fa-folder"></i>
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <!--<button type="button" class="btn btn-default" title="Tag"><i class="fa fa-tag"></i></button>-->
            <ul class="dropdown-menu" role="menu">
                <li class="moveto-inbox-menu"><a href="#">Move to Inbox</a></li>
                <li class="moveto-trash-menu"><a href="#">Move to Trash</a></li>
            </ul>
        </div>

        <div class="more-btn btn-group">
            <button type="button" class="btn btn-default  btn-sm dropdown-toggle" data-toggle="dropdown">
                More
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="mark-allread-menu"><a href="#">Mark all as read</a></li>
                <li class="mark-unread-menu"><a href="#">Mark as unread</a></li>
                <li class="mark-read-menu"><a href="#">Mark as read</a></li>
            </ul>
        </div>

        <div class="pull-right" style="display:inline-block; margin-left: 15px; vertical-align: top; text-align: right;">
            <small class="page-indicator">1-100 of 1024</small>
            <br/>
            <i class="prev-btn fa fa-chevron-left"></i>&nbsp;&nbsp;&nbsp;
            <i class="next-btn fa fa-chevron-right"></i>

            <!-- <div class="btn-group">
              <button type="button" class="btn btn-default"><i class="fa fa-chevron-left"></i></button>
              <button type="button" class="btn btn-default"><i class="fa fa-chevron-right"></i></button>
            </div> -->

        </div>
    </header>

    <div id="maillistWrapper" data-layout="fill-parent">
        <!-- <div class="toolbar-placeholder"></div> -->

        <div id="mailListState" class="hidden alert alert-info" role="alert">
            Oops! No mail found. Try to sync it.
        </div>

        <dl class="mail-list">

            <!--<dd class="mail-list-item unread">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fav-btn fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>Facebook</strong>-->
                    <!--<span class="pull-right">3:04 (1小时前)</span>-->
                <!--</div>-->
                <!--<h4>Do you know Tony Townsend, Boyu Wang and 8 others?</h4>-->
            <!--</dd>-->


            <!--<dd class="mail-list-item unread">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>Pinterest</strong>-->
                    <!--<span class="pull-right">September 21</span>-->
                <!--</div>-->
                <!--<h4>Another thing you can do on Pinterest: Renovate your home!</h4>-->
                <!--<p>Did you know you can also use Pinterest to plan out any improvements-->
                    <!--you want to make to your home? So if you’re redecorating your living-->
                    <!--room, just do a quick search to see what rugs,-->
                    <!--couches and other great ideas people have discovered. </p>-->
            <!--</dd>-->


            <!--<dd class="mail-list-item active">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>OpenShift by Red Hat</strong>-->
                    <!--<span class="pull-right">21:39 (4小时前)</span>-->
                <!--</div>-->
                <!--<h4>Announcing Dedicated Node Services</h4>-->
                <!--<p>-->
                    <!--Last week we announced Dedicated Node Services for OpenShift.-->
                    <!--Dedicated Node gives Enterprise users more options and power than ever,-->
                    <!--providing customized and dedicated-->
                <!--</p>-->
            <!--</dd>-->

            <!--<dd class="mail-list-item">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>OpenShift by Red Hat</strong>-->
                      <!--<span class="pull-right">-->
                        <!--<i class="fa fa-paperclip"></i>-->
                         <!--21:39 (4小时前)</span>-->
                <!--</div>-->
                <!--<h4>Work Inquire from Apple</h4>-->
                <!--<p>-->
                    <!--Last week we announced Dedicated Node Services for OpenShift.-->
                    <!--Dedicated Node gives Enterprise users more options and power than ever,-->
                    <!--providing customized and dedicated nodes to-->
                <!--</p>-->
            <!--</dd>-->

            <!--<dd class="mail-list-item">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>OpenShift by Red Hat</strong>-->
                    <!--<span class="pull-right">21:39 (4小时前)</span>-->
                <!--</div>-->
                <!--<h4>Work Inquire from Apple</h4>-->
                <!--<p>-->
                    <!--Last week we announced Dedicated Node Services for OpenShift.-->
                    <!--Dedicated Node gives Enterprise users more options and power than ever,-->
                    <!--providing customized and dedicated nodes to-->
                <!--</p>-->
            <!--</dd>-->

            <!--<dd class="mail-list-item">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>OpenShift by Red Hat</strong>-->
                    <!--<span class="pull-right">21:39 (4小时前)</span>-->
                <!--</div>-->
                <!--<h4>Work Inquire from Apple</h4>-->
                <!--<p>-->
                    <!--Last week we announced Dedicated Node Services for OpenShift.-->
                    <!--Dedicated Node gives Enterprise users more options and power than ever,-->
                    <!--providing customized and dedicated nodes to-->
                <!--</p>-->
            <!--</dd>-->

            <!--<dd class="mail-list-item">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>OpenShift by Red Hat</strong>-->
                    <!--<span class="pull-right">21:39 (4小时前)</span>-->
                <!--</div>-->
                <!--<h4>Work Inquire from Apple</h4>-->
                <!--<p>-->
                    <!--Last week we announced Dedicated Node Services for OpenShift.-->
                    <!--Dedicated Node gives Enterprise users more options and power than ever,-->
                    <!--providing customized and dedicated nodes to-->
                <!--</p>-->
            <!--</dd>-->

            <!--<dd class="mail-list-item">-->
                <!--<div class="action-controls">-->
                    <!--<input type="checkbox" />-->
                    <!--<div style="margin-top:8px;">-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="writer">-->
                    <!--<strong>OpenShift by Red Hat</strong>-->
                    <!--<span class="pull-right">21:39 (4小时前)</span>-->
                <!--</div>-->
                <!--<h4>Announcing Dedicated Node Services</h4>-->
                <!--<p>-->
                    <!--Last week we announced Dedicated Node Services for OpenShift.-->
                    <!--Dedicated Node gives Enterprise users more options and power than ever,-->
                    <!--providing customized and dedicated nodes to-->
                <!--</p>-->
            <!--</dd>-->
        </dl>

        <div>
            <div class="btn-group" style="margin: 0 auto;">
                <button type="button" class="prev-btn btn btn-default btn-sm"><i class="fa fa-chevron-left"></i></button>
                <button type="button" class="next-btn btn btn-default btn-sm"><i class="fa fa-chevron-right"></i></button>
            </div>
            <span class="page-indicator">1-100 of 1024</span>
        </div>

    </div>

</aside>

<!-- Mail content -->
<aside class="right-side x-col">

    <div class="column-header">
        <div class="pull-right">
            <div class="btn-group">
                <button type="button" class="btn btn-default btn-sm"><i class="fa fa-chevron-left"></i></button>
                <button type="button" class="btn btn-default btn-sm"><i class="fa fa-chevron-right"></i></button>
            </div>
        </div>
        <h2 class="mail-title"></h2>
    </div>

    <header class="toolbar">
        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm"><i class="fa fa-archive"></i></button>
            <button type="button" class="btn btn-default btn-sm"><i class="fa fa-info-circle"></i></button>
            <button type="button" class="btn btn-default btn-sm"><i class="fa fa-trash"></i></button>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-default btn-sm"><i class="fa fa-folder"></i></button>
            <button type="button" class="btn btn-default btn-sm"><i class="fa fa-tag"></i></button>
        </div>

    </header>

    <div id="mailViewport" data-layout="fill-parent" style="height: 600px; overflow-y:auto; padding-bottom: 80px;">

        <article class="mail-entry">
            <div class="mail-info">
                <div class="pull-right">
                    <strong>21:39 (6小时前)</strong>
                </div>
                <h3>OpenShift by Red Hat</h3>
                <p><span>openshift-email@redhat.com</span> to me</p>
            </div>

            <hr/>

            <div class="mail-body">

                <p>Hello,</p>
                <p>Last week we announced Dedicated Node Services for OpenShift. </p>

                <p>
                    Dedicated Node gives Enterprise users more options and power than ever, providing customized and dedicated nodes to host your applications.  Best of all, it's all managed by Red Hat.
                </p>
                <p>
                    Key benefits include:

                <ol>
                    <li>Isolated gears in customizable sizes</li>
                    <li>Global availability--any hosting region AWS EC2 supports</li>
                    <li>VPC between your data center and dedicated node</li>
                    <li>Professional monitoring</li>
                    <li>Award-winning Red Hat support</li><li>Learn more and get your subscription under way by clicking here.</li>
                </ol>

                <p>and,</p>
                <blockquote>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </blockquote>
            </div><!-- end .mail-body -->

            <hr/>
            <div class="mail-attachments">
                <h5><i class="fa fa-paperclip"></i> Attachments <small>(3 files, 680kb)</small></h5>
                <div class="list-group">
                    <a href="#" class="list-group-item"><i class="fa fa-file-o"></i> force.gif <small>(128kb)</small></a>
                    <a href="#" class="list-group-item"><i class="fa fa-file-o"></i> lighsaber.png</a>
                    <a href="#" class="list-group-item"><i class="fa fa-file-o"></i> hax.html</a>
                </div>
            </div>

        </article>

        <!--<hr/>-->
        <!--<div class="mail-reply">-->
            <!--<textarea cols="100" rows="5" placeholder="Click to Reply or Forward"></textarea>-->
        <!--</div>-->

    </div>
</aside>
</div>

<div id="dlgProgress" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <!-- <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span></button> -->
                <h4 class="modal-title" id="myModalLabel">Loading</h4>
            </div>
            <div class="modal-body">
                <div class="progress auto-progress">
                    <div class="progress-bar progress-bar-success progress-bar-striped active"
                         role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                        <span class="sr-only">100% Complete (success)</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
            </div>
        </div>
    </div>
</div>


<div id="dlgSetting" class="modal fade bs-example-modal-md" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <!-- <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span></button> -->
                <h4 class="modal-title">Settings</h4>
            </div>
            <div class="modal-body">

                <form class="form-horizontal" role="form">
                    <div class="form-group">
                        <label for="txtPopServer" class="col-sm-4 control-label">Incoming Mail Server</label>
                        <div class="col-sm-8">
                            <input type="email" class="form-control" id="txtPopServer" placeholder="pop.yourmailserver.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtEmail" class="col-sm-4 control-label">Email Address</label>
                        <div class="col-sm-8">
                            <input type="email" class="form-control" id="txtEmail" placeholder="john@foobar.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtUsername" class="col-sm-4 control-label">User Name</label>
                        <div class="col-sm-8">
                            <input type="email" class="form-control" id="txtUsername" placeholder="John">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputPassword3" class="col-sm-4 control-label">Password</label>
                        <div class="col-sm-8">
                            <input type="password" class="form-control" id="inputPassword3" placeholder="Password">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-4 col-sm-8">
                            <div class="checkbox">
                            <label>
                                <input id="chkSSL" type="checkbox"> Use SSL
                            </label>
                            </div>
                        </div>
                    </div>
                    <!--<div class="form-group">-->
                        <!--<div class="col-sm-offset-3 col-sm-9">-->
                            <!--<div class="checkbox">-->
                                <!--<label>-->
                                    <!--<input type="checkbox"> Remember me-->
                                <!--</label>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="form-group">-->
                        <!--<div class="col-sm-offset-3 col-sm-9">-->
                            <!--<button type="submit" class="btn btn-default">Sign in</button>-->
                        <!--</div>-->
                    <!--</div>-->

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="/resources/js/jquery-2.1.1.js"></script>
<script src="/resources/js/bootstrap.js"></script>
<script src="/resources/js/underscore-min.js"></script>
<script src="/resources/js/backbone-min.js"></script>
<script src="/resources/js/notify.min.js"></script>
<script src="/resources/js/webmail.js"></script>

<script>

    var currentFolder = 'inbox';
    var pagination = new Pagination();

    function adjustColumnsHeight() {
        var col_h = $('.left-side').height();

        var calc_offset = function() {
            var tb = $('.toolbar', this);
            var offset = tb.outerHeight() + tb.offset().top;
            return offset;
        }

        $('.x-col:has([data-layout])').each(function(i, n){
            var offset = calc_offset.call(this);
            var _h = col_h - offset;
            $(this).find('[data-layout=fill-parent]').css({"height": _h});
        })
    }

    function setMailListState(haveMail) {
        var state = $('#mailListState');

        if (haveMail) {
            state.addClass('hidden');
        } else {
            state.removeClass('hidden');
        }
    }

    function loadProfile() {
        var xhr = $.get('/rest/user/profile', function(data, textStatus, response) {

            var state = response.getResponseHeader('x-state');

            if (textStatus == 'success' && state == 'ok') {
                $('#profile').html(data);
            }
        }).fail(function() {
            Noty.error("Load profile failed.")
        })
    }

    function loadMails(folder, page, firstInvoke) {

        folder = folder || currentFolder || 'inbox';
        page = page || pagination.page() || '1'; // page 1 as default

        // clean container firstly
        var listContainer = $('#maillist .mail-list').empty();


        var xhr = $.get('/rest/mail/list',
                {'folder': folder, 'page': page},
                function(data, textStatus, response) {

            if (textStatus == 'success' && response) {
                var total = parseInt(response.getResponseHeader('x-total'));
                var page = parseInt(response.getResponseHeader('x-page'));
                var pageSize = parseInt(response.getResponseHeader('x-page-size'));
                var position = parseInt(response.getResponseHeader('x-position'));

                if (total && total > 0) {
                    listContainer.append(data);

                    pagination.update(page, pageSize, total);

                    setMailListState(true);
                    updateUI();
                } else {
                    Noty.info("No more mails to load.")
                }

                if (!!firstInvoke && total <= 0) {
                    setMailListState(false);
                }
            }
        }).fail(function() {
            Noty.error("Load mail failed, please try it later.")
        })
    }

    function syncMails() {
        var progressDialog = $('#dlgProgress').modal();

        var ajax = $.getJSON("/rest/mail/sync", function(data){
            if (data && data.state === 'ok') {
                if (data.update) {
                    loadMails();
                } else {
                    Noty.info("No new messages received");
                }
            } else {
                Noty.error("Sync mail failed, please try it later.")
            }
        }).fail(function(xhr) {
            if (xhr.statusText === 'abort') {
                return; // just ignore
            }
            Noty.error("Sync mail failed, please try it later.")
        }).always(function() {
            progressDialog.modal('hide');
            progressDialog.off('hidden.bs.modal');
        });

        progressDialog.on('hidden.bs.modal', function() {
            ajax.abort();
        })
    }

    function openMail(id, callback) {

        var data = {'id' : id};

        callback = callback || function(){};

        $.get('/rest/mail/read', data, function(data, textStatus, response) {
            var state = response.getResponseHeader('x-state');
            var msg = response.getResponseHeader('x-exception') || response.getResponseHeader('x-msg') || '';

            if (state == 'ok' && data) {
                $('#mailViewport .mail-entry').html(data);
                $('.mail-list-item[data-id=' + id +']').removeClass('unread');

                try {
                    callback();
                } catch (e) {}
            } else {
                Noty.error("Open mail failed. " + msg)
            }
        }).fail(function() {
            Noty.error("Open mail failed, please try it later.")
        })
    }

    /**
     * Actions for mail or mails.
     * @param ctrlType (string) could be delete | trash | star | unstar
     */
    function ctrlMail(id, ctrlType, callback) {

        // don't disturb trashing but deleting
        if (ctrlType == 'delete' && !confirm('Are you sure to delete?')) {
            return;
        }

        callback = callback || function(){};

        var params = {};
        params.id = id;
        params.action = ctrlType;

        $.get('/rest/mail/control', params, function(data, textStatus, response) {

            var state = response.getResponseHeader('x-state');
            var msg = response.getResponseHeader('x-exception') || response.getResponseHeader('x-msg') || '';

            if (state == 'ok') {
                try {
                    callback();
                } catch (e) {}
            } else {
                Noty.error(ctrlType + " mail failed. " + msg)
            }
        }).fail(function(){
        })
    }

    function initializeUI() {
        adjustColumnsHeight();

        // reset mail reading area
        $('#mailViewport .mail-entry').empty();

        // update page indicator
        $('.page-indicator').text('0 of 0');

        // hide delete btn
        $('#maillist .toolbar button:has(.fa-trash)').addClass('hidden');

    }

    /**
     * Update buttons and indicators
     */
    function updateUI() {

        // ------------------------- mail list toolbar

        var refreshButton = $('#maillist .toolbar .refresh-btn');
        var removeButton = $('#maillist .toolbar .delete-btn');
        var movetoButton = $('#maillist .toolbar .moveto-btn');

        var haveSelection = $('.mail-list-item.selected').size() > 0;

        refreshButton.toggleClass('hidden', haveSelection);
        removeButton.toggleClass('hidden', !haveSelection);
        movetoButton.toggleClass('hidden', !haveSelection);


        // update the tip of delete button
        if (currentFolder == 'inbox' || currentFolder == 'fav') {
            removeButton.attr('title', 'Move to trash');
        }
        else {
            removeButton.attr('title', 'Delete forever');
        }

        // update 'select-all' button icon
        var updateSelectAllButton = function(allSelected) {

            var toggleIt = function(btn, toggle) {
                $(btn).find('i.fa').
                        toggleClass('fa-check-square-o', toggle).
                        toggleClass('fa-square-o', !toggle);
            };

            if (arguments.length > 0) {
                toggleIt(this, allSelected);
            }
            else {
                var itemsAll = $('#maillist .mail-list-item');
                var selected = itemsAll.filter('.selected');
                var btn = $('#maillist').find('.select-btn button.select-all-btn')[0];
                toggleIt(btn, itemsAll.size() == selected.size() && itemsAll.size() != 0);
            }
        };
        updateSelectAllButton();

        // ------------------------- pagination buttons
        if (!pagination.hasPrev()) {
            $('#maillistWrapper .prev-btn').attr('disabled', 'disabled');
            $('#maillist .toolbar .prev-btn').attr('disabled', 'disabled');
        } else {
            $('#maillistWrapper .prev-btn').removeAttr('disabled');
            $('#maillist .toolbar .prev-btn').removeAttr('disabled');
        }
        if (!pagination.hasNext()) {
            $('#maillistWrapper .next-btn').attr('disabled', 'disabled');
            $('#maillist .toolbar .next-btn').attr('disabled', 'disabled');
        } else {
            $('#maillistWrapper .next-btn').removeAttr('disabled');
            $('#maillist .toolbar .next-btn').removeAttr('disabled');
        }

    }

    // actions include favorite and trash and delete
    function bindMailActions() {

        // star or unstar
        $('#maillist').on('click', '.mail-list-item .action-controls .fav-btn', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            var self = this;
            var listItem = $(this).parents('.mail-list-item:first');
            var id = listItem.data('id');
            var was_favorite = $(this).hasClass('fa-star');

            var ctrl = was_favorite ? 'unstar' : 'star';

            ctrlMail(id, ctrl, function() {
                if (was_favorite) {
                    $(self).removeClass('fa-star').addClass('fa-star-o');
                    Noty.success('You un-star it!');
                } else {
                    $(self).removeClass('fa-star-o').addClass('fa-star');
                    Noty.success('You star it!');
                }
            });

            updateUI();
        });

        // delete permanently
        $('#maillist').on('click', '.mail-list-item .action-controls .del-btn', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            if (!confirm('Are you sure to delete?')) {
                return;
            }

            var listItem = $(this).parents('.mail-list-item:first');
            var id = listItem.data('id');

            ctrlMail(id, 'delete', function() {
                listItem.fadeOut(function(){
                    $(this).remove()
                });
                Noty.success('Mail has been deleted forever!');
            });

            updateUI();
        });

        // selection
        $('#maillist').on('click', '.mail-list-item .action-controls :checkbox', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            $(this).parents('.mail-list-item:first').trigger(
                    $(this).is(':checked') ? 'select' : 'unselect')

            updateUI();
        })
    }


    /**
     * Open a mail in the right side.
     */
    function bindMailOpen() {
        $('.mail-list').on('click', '.mail-list-item', function(e){
            // if event source was a checkbox or favorite button
            // or action control panel, ignore it.
            if ($(e.target).is(':checkbox,.fav-btn,.action-controls')) {
                return;
            }

            var offsetX = e.offsetX || e.offsetLeft;

            // skip controls area.
            if (offsetX < 30) {
                return;
            }

            var id = $(this).data('id');

            if (!id) {
                return;
            }

            var self = this;

            openMail(id, function(){
                // change list item state indicator
                $(self).siblings().removeClass('active').end().addClass('active');
                // change url hash
                location.hash = '#/mail/read/' + id;
            });
        })
    }


    function bindMailListMenu() {

        // customize event 'select' and 'unselect', and delegate to #maillist
        $('#maillist').on('select', '.mail-list-item', function() {
            $(this).addClass('selected').find('.action-controls :checkbox').prop('checked', 'checked');
        }).on('unselect', '.mail-list-item', function() {
            $(this).removeClass('selected').find('.action-controls :checkbox:checked').removeAttr('checked');
        });

        //Delete mail or mails async.
        $('#maillist').on('click', '.delete-btn', function(e) {

            var chks = $('.mail-list-item [name=chkSelected]:checked');

            if (chks.size() == 0) {
                return;
            }

            var ids = [];

            chks.each(function() {
                ids[ids.length] = $(this).val();
            })

            var ctrl = currentFolder == 'trash' ? 'delete' : 'trash';

            ctrlMail(ids.join(','), ctrl, function() {
                chks.parents('.mail-list-item').fadeOut(function(){
                    $(this).remove()
                });
            });
        });

        var filterMails = function(filter) {
            var items = [];
            var itemsAll = $('#maillist .mail-list-item');

            // nothing in mail list
            if (itemsAll.size() == 0) {
                return;
            }

            filter = filter || function() {return false};

            itemsAll.each(function() {
                var accept = filter(this);
                if (accept) {
                    items[items.length] = this;
                }
            })

            return items;
        }

        var toggleMailSelection = function(isSelect, filter) {
            var items = filterMails(filter);

            if (items.length == 0) {
                return;
            }

            if (!isSelect) {
                $(items).trigger('unselect')
            } else {
                $(items).trigger('select')
            }

            updateUI();
        }

        // select or un-select all directly
        $('#maillist').on('click', '.select-btn button.select-all-btn', function() {
            var isSelectAll = $(this).find('.fa-square-o').size() > 0;
            toggleMailSelection(isSelectAll, function(mail) {
                return true; // bingo, that means ALL are accepted
            });
        });

        // --------------------- menus
        //select-all-menu
        $('#maillist').on('click', '.select-btn .select-all-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return true;
            });
        });
        //select-none-menu
        $('#maillist').on('click', '.select-btn .select-none-menu', function(e){
            toggleMailSelection(false, function(mail) {
                return true;
            });
        });
        //select-star-menu
        $('#maillist').on('click', '.select-btn .select-star-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return $(mail).find('i.fa-star').size() > 0;
            });
        });
        //select-unstar-menu
        $('#maillist').on('click', '.select-btn .select-unstar-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return $(mail).find('i.fa-star-o').size() > 0;
            });
        });
        $('#maillist').on('click', '.select-btn .select-read-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return !$(mail).hasClass('unread');
            });
        });
        $('#maillist').on('click', '.select-btn .select-unread-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return $(mail).hasClass('unread');
            });
        })


        // --------------------- move-to button

        var MoveSelectedTo = function(folder) {
            if (currentFolder == folder) {
                return;
            }

            var foldersMap = {
                'inbox' : 'untrash',
                'trash' : 'trash'
            }

            var ctrl = foldersMap[folder];

            if (!ctrl) { // incorrect folder, only support these two
                return;
            }

            // get all selected
            var items = filterMails(function(mail){
                return $(mail).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), ctrl, function() {
                loadMails();
            });
        };

        // move selected mail or mails to <b>INBOX</b> folder.
        $('#maillist').on('click', '.moveto-btn .moveto-inbox-menu', function() {
            MoveSelectedTo('inbox');
        });

        // move selected mail or mails to <b>TRASH</b> folder.
        $('#maillist').on('click', '.moveto-btn .moveto-trash-menu', function() {
            MoveSelectedTo('trash');
        });


        // --------------------- more button

        // mark all that all unread mails in current page as read
        $('#maillist').on('click', '.more-btn .mark-allread-menu', function() {
            // get all unread
            var items = filterMails(function(mail){
                return $(mail).hasClass('unread');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), 'read', function() {
                $(items).removeClass('unread');
            });
        });

        // mark all that selected mails in current page as read
        $('#maillist').on('click', '.more-btn .mark-read-menu', function() {
            // get all selected
            var items = filterMails(function(mail){
                return $(mail).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), 'read', function() {
                $(items).toggleClass('unread', false);
            });
        });

        // mark all that selected mails in current page as unread
        $('#maillist').on('click', '.more-btn .mark-unread-menu', function() {
            // get all selected
            var items = filterMails(function(mail){
                return $(mail).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), 'unread', function() {
                $(items).toggleClass('unread', true);
            });
        });


        // --------------------- pagination handler

        $('#maillistWrapper').on('click', '.prev-btn', function() {
            loadMails(currentFolder, pagination.prev());
        });
        $('#maillistWrapper').on('click', '.next-btn', function() {
            loadMails(currentFolder, pagination.next());
        });
        $('#maillist').on('click', '.toolbar .prev-btn', function() {
            loadMails(currentFolder, pagination.prev());
        });
        $('#maillist').on('click', '.toolbar .next-btn', function() {
            loadMails(currentFolder, pagination.next());
        });
    }

    // To switch mail folder
    function bindFolderSwitch() {
        $('#mainMenu > li').on('click', function(e) {

            var self = this;

            if ($(self).is('.active')) {
                return;
            }

            var folder = $(this).data('name');

            currentFolder = folder;

            $(this).siblings().removeClass('active')
                    .end().addClass('active');

            $('#lblFolderName').text($(self).text());

            pagination.reset();

            loadMails(folder);
        })
    }

    $(window).resize(function(){
        adjustColumnsHeight();
    });


    // when this page got loaded
    $(function(){

        initializeUI();

        // Synchronize mails
        $('#maillist').on('click', '.refresh-btn', syncMails);

        // Show settings dialog
        $('#tbSystem').on('click', '.settings-btn', function() {
            $('#dlgSetting').modal();
        });

        // Logout the system
        $('#tbSystem').on('click', '.logout-btn', function(){
            if (confirm('Do you really want to leave?')) {
                location.href = '/logout';
            }
        });

        bindFolderSwitch();

        bindMailOpen();

        bindMailListMenu();

        bindMailActions();

        // load profile fragment
        loadProfile();

        // load mails when page loaded
        loadMails('inbox', 1, true);

        updateUI();
    })
</script>

</body>
</html>
