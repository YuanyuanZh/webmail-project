
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web Mail</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- bootstrap 3.0.2 -->
    <link href="/resources/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!--  -->
    <link href="/resources/css/bootstrap.progress-auto.css" rel="stylesheet" type="text/css" />
    <!-- font Awesome -->
    <link href="/resources/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

    <link href="/resources/js/magicsuggest/magicsuggest-min.css" rel="stylesheet" type="text/css" />

    <link href="/resources/css/mail.css" rel="stylesheet" type="text/css" />
    <link href="/resources/css/mail-resp.css" rel="stylesheet" type="text/css" />

    <!-- favicon from https://dribbble.com/shots/1297277-Adline-Social-icons-Retouched?list=searches&tag=mail_icon&offset=11 -->
    <link rel="shortcut icon" href="/resources/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/resources/img/favicon.ico" type="image/x-icon">


    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body class="">


<div class="wrapper">
<aside class="left-side x-col">
    <div id="profile" class="profile column-header">
        <!--<img src="/resources/img/avatar/avatar_2x.png" height="40" width="40" class="profile-avatar img-circle img-thumbnail" alt="Avatar" />-->
        <span class="profile-name"></span>
    </div>

    <div class="left-side-tabs">
        <ul class="nav nav-tabs nav-justified">
            <li role="presentation" class="active"><a href="#">Mail</a></li>
            <li role="presentation"><a href="/contacts">Contacts</a></li>
        </ul>
    </div>

    <div style="padding: 1.4em 1em;">
        <button class="btn btn-primary btn-block compose-btn btn-disabled"><i class="fa fa-pencil-square-o"></i>&nbsp;&nbsp; Compose</button>
    </div>

    <div style="padding: 0;">
        <ul id="mainMenu" class="nav nav-stacked mail-menu">
            <li id="folderInbox" class="active" data-name="inbox"><a href="#/mail/list/inbox"><i class="fa fa-inbox"></i> <span>Inbox</span>
                <!--<small class="badge pull-right bg-green">192</small>-->
            </a></li>
            <!--<li data-name="sent"><a href="#/mail/list/sent"><i class="fa fa-archive"></i> <span>Sent</span></a></li>-->
            <li data-name="fav"><a href="#/mail/list/starred"><i class="fa fa-star-o"></i> <span>Starred</span></a></li>
            <!--<li><a href="#"><i class="fa fa-file-o"></i> <span>Drafts</span></a></li>-->
            <li data-name="trash"><a href="#"><i class="fa fa-trash"></i> <span>Trash</span></a></li>
        </ul>

    </div>

    <div id="tbSystem" class="toolbar toolbar-bottom">
        <div class="btn-group" style="position: absolute; bottom: 1.5em; left: 50%; margin-left: -34px;">
            <button class="btn btn-default logout-btn"><i class="fa fa-power-off"></i></button>
            <button class="btn btn-default settings-btn"><i class="fa fa-cog"></i></button>
        </div>
    </div>

</aside>

<!-- Mail list -->
<aside id="maillist" class="second-left-side x-col">

    <div class="column-header">
        <!--<div class="search-box pull-right">-->
            <!--<input class="" placeholder="Search Mail..." type="text" />-->
            <!--<span class="search-icon"><i class="fa fa-search"></i></span>-->
        <!--</div>-->

        <h2 id="lblFolderName" class="folder-name">Inbox</h2>
    </div>

    <header class="toolbar">

        <div class="select-btn btn-group">
            <button class="select-all-btn btn btn-default  btn-sm">
                <i class="fa fa-square-o"></i>
            </button>
            <button type="button" class="btn btn-default  btn-sm dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="select-all-menu"><a href="#">All</a></li>
                <li class="select-none-menu"><a href="#">None</a></li>
                <li class="select-read-menu"><a href="#">Read</a></li>
                <li class="select-unread-menu"><a href="#">Unread</a></li>
                <li class="select-star-menu"><a href="#">Starred</a></li>
                <li class="select-unstar-menu"><a href="#">Unstarred</a></li>
            </ul>
        </div>

        <div class="btn-group">
            <!-- <button class="btn btn-default"><i class="fa fa-refresh"></i></button> -->
            <button class="btn btn-default refresh-btn  btn-sm"><i class="fa fa-refresh"></i></button>
        </div>
        <div class="btn-group">
            <!--<button type="button" class="btn btn-default"><i class="fa fa-archive"></i></button>-->
            <!--<button type="button" class="btn btn-default"><i class="fa fa-info-circle"></i></button>-->
            <button type="button" class="btn btn-default delete-btn  btn-sm"><i class="fa fa-trash"></i></button>
        </div>

        <div class="moveto-btn btn-group">
            <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown"
                    title="Move to">
                <i class="fa fa-folder"></i>
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <!--<button type="button" class="btn btn-default" title="Tag"><i class="fa fa-tag"></i></button>-->
            <ul class="dropdown-menu" role="menu">
                <li class="moveto-inbox-menu"><a href="#">Move to Inbox</a></li>
                <li class="moveto-trash-menu"><a href="#">Move to Trash</a></li>
            </ul>
        </div>

        <div class="more-btn btn-group">
            <button type="button" class="btn btn-default  btn-sm dropdown-toggle" data-toggle="dropdown">
                More
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="mark-allread-menu"><a href="#">Mark all as read</a></li>
                <li class="mark-unread-menu"><a href="#">Mark as unread</a></li>
                <li class="mark-read-menu"><a href="#">Mark as read</a></li>
            </ul>
        </div>

        <div class="pull-right" style="display:inline-block; margin-left: 15px; vertical-align: top; text-align: right;">
            <small class="page-indicator">1-100 of 1024</small>
            <br/>
            <i class="prev-btn fa fa-chevron-left"></i>&nbsp;&nbsp;&nbsp;
            <i class="next-btn fa fa-chevron-right"></i>

            <!-- <div class="btn-group">
              <button type="button" class="btn btn-default"><i class="fa fa-chevron-left"></i></button>
              <button type="button" class="btn btn-default"><i class="fa fa-chevron-right"></i></button>
            </div> -->

        </div>
    </header>

    <div id="maillistWrapper" data-layout="fill-parent">
        <!-- <div class="toolbar-placeholder"></div> -->

        <div id="mailListState" class="hidden alert alert-info" role="alert">
            Oops! No mail found. Try to sync it.
        </div>

        <dl class="mail-list">

        </dl>

        <div>
            <div class="btn-group" style="margin: 0 auto;">
                <button type="button" class="prev-btn btn btn-default btn-sm"><i class="fa fa-chevron-left"></i></button>
                <button type="button" class="next-btn btn btn-default btn-sm"><i class="fa fa-chevron-right"></i></button>
            </div>
            <span class="page-indicator">1-100 of 1024</span>
        </div>

    </div>

</aside>

<!-- Mail content -->
<aside class="right-side x-col">

    <div class="column-header">
        <h2 class="mail-title"></h2>
    </div>

    <header class="toolbar">

        <button type="button" class="delete-btn btn btn-default btn-sm"><i class="fa fa-trash"></i> Delete</button>

        <div class="btn-group reply">
            <button type="button" class="reply-btn btn btn-default btn-sm"><i class="fa fa-reply"></i> Reply</button>
            <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li class="reply-all-menu"><a href="#"><i class="fa fa-reply"></i> Reply All</a></li>
                <li class="forward-menu"><a href="#"><i class="fa fa-share"></i> Forward</a></li>
            </ul>
        </div>

    </header>

    <div id="mailViewport" data-layout="fill-parent" style="height: 600px; overflow-y:auto; padding-bottom: 80px;">

        <article class="mail-entry">
            <div class="mail-info">
                <div class="pull-right">
                    <strong>21:39 (6小时前)</strong>
                </div>
                <h3>OpenShift by Red Hat</h3>
                <p><span>openshift-email@redhat.com</span> to me</p>
            </div>

            <hr/>

            <div class="mail-body">

                <p>Hello,</p>
                <p>Last week we announced Dedicated Node Services for OpenShift. </p>

                <p>
                    Dedicated Node gives Enterprise users more options and power than ever, providing customized and dedicated nodes to host your applications.  Best of all, it's all managed by Red Hat.
                </p>
                <p>
                    Key benefits include:

                <ol>
                    <li>Isolated gears in customizable sizes</li>
                    <li>Global availability--any hosting region AWS EC2 supports</li>
                    <li>VPC between your data center and dedicated node</li>
                    <li>Professional monitoring</li>
                    <li>Award-winning Red Hat support</li><li>Learn more and get your subscription under way by clicking here.</li>
                </ol>

                <p>and,</p>
                <blockquote>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </blockquote>
            </div><!-- end .mail-body -->

            <hr/>
            <div class="mail-attachments">
                <h5><i class="fa fa-paperclip"></i> Attachments <small>(3 files, 680kb)</small></h5>
                <div class="list-group">
                    <a href="#" class="list-group-item"><i class="fa fa-file-o"></i> force.gif <small>(128kb)</small></a>
                    <a href="#" class="list-group-item"><i class="fa fa-file-o"></i> lighsaber.png</a>
                    <a href="#" class="list-group-item"><i class="fa fa-file-o"></i> hax.html</a>
                </div>
            </div>

        </article>

        <!--<hr/>-->
        <!--<div class="mail-reply">-->
            <!--<textarea cols="100" rows="5" placeholder="Click to Reply or Forward"></textarea>-->
        <!--</div>-->

    </div>
</aside>
</div>

<div id="dlgProgress" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <!-- <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span></button> -->
                <h4 class="modal-title" id="myModalLabel">Please wait a second...</h4>
            </div>
            <div class="modal-body">
                <div class="progress auto-progress">
                    <div class="progress-bar progress-bar-success progress-bar-striped active"
                         role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                        <span class="sr-only">100% Complete (success)</span>
                    </div>
                </div>
            </div>
            <!--<div class="modal-footer">-->
                <!--<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>-->
                <!--&lt;!&ndash; <button type="button" class="btn btn-primary">Save changes</button> &ndash;&gt;-->
            <!--</div>-->
        </div>
    </div>
</div>


<div id="dlgSetting" class="modal fade bs-example-modal-md" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <!-- <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span></button> -->
                <h4 class="modal-title">Settings</h4>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer">
                <button type="button" class="no-btn btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="yes-btn btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="dlgCompose" class="modal fade bs-example-modal-md" tabindex="-1" role="dialog"
     aria-labelledby="Compose Mail" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">New mail</h4>
            </div>
            <div class="modal-body">

                <form class="form-horizontal" role="form">
                    <div class="form-group">
                        <label for="txtTo" class="col-sm-2 control-label">To</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="txtTo" name="to" placeholder="" />
                        </div>
                    </div>
                    <div class="form-group hidden group-cc">
                        <label for="txtCC" class="col-sm-2 control-label">Cc</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="txtCc" name="cc" placeholder="">
                        </div>
                    </div>
                    <div class="form-group hidden group-bcc">
                        <label for="txtBcc" class="col-sm-2 control-label">Bcc</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="txtBcc" name="bcc" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <!-- toggle cc & bcc input -->
                            <a href="#" class="toggle-btn" data-toggle=".group-cc" ><span>Add</span> Cc</a>
                            <span style="color: #EDEDED;">|</span>
                            <a href="#" class="toggle-btn" data-toggle=".group-bcc"><span>Add</span> Bcc</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtSubject" class="col-sm-2 control-label">Subject</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="txtSubject" name="subject" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtContent" class="col-sm-2 control-label">Content</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" id="txtContent" name="content"  placeholder=""
                                    style="height: 160px;"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="no-btn btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="yes-btn btn btn-primary"><i class="fa fa-send"></i> Send</button>
            </div>
        </div>
    </div>
</div>

<script src="/resources/js/jquery-2.1.1.js"></script>
<script src="/resources/js/bootstrap.js"></script>
<!--<script src="/resources/js/underscore-min.js"></script>-->
<!--<script src="/resources/js/backbone-min.js"></script>-->
<script src="/resources/js/notify.min.js"></script>
<script src="/resources/js/magicsuggest/magicsuggest-min.js"></script>

<script src="/resources/js/webmail.js"></script>

<script>

    var currentFolder = 'inbox';
    var pagination = new Pagination();

    function isArray(obj) {
        return typeof obj == 'object' &&
                Object.prototype.toString.call(obj) == '[object Array]';
    }

    function adjustColumnsHeight() {
        var col_h = $('.left-side').height();

        var calc_offset = function() {
            var tb = $('.toolbar', this);
            var offset = tb.outerHeight() + tb.offset().top;
            return offset;
        }

        $('.x-col:has([data-layout])').each(function(i, n){
            var offset = calc_offset.call(this);
            var _h = col_h - offset;
            $(this).find('[data-layout=fill-parent]').css({"height": _h});
        })
    }

    function setMailListState(haveMail) {
        var state = $('#mailListState');

        if (haveMail) {
            state.addClass('hidden');
        } else {
            state.removeClass('hidden');
        }
    }

    function loadProfile() {
        var xhr = $.get('/rest/user/profile', function(data, textStatus, response) {

            var state = response.getResponseHeader('x-state');

            if (textStatus == 'success' && state == 'ok') {
                $('#profile').html(data);
            }
        }).fail(function() {
            Noty.error("Load profile failed.")
        })
    }

    function loadMailList(folder, page, firstInvoke) {

        folder = folder || currentFolder || 'inbox';
        page = page || pagination.page() || '1'; // page 1 as default

        // clean container firstly
        var listContainer = $('#maillist .mail-list').empty();


        var xhr = $.get('/rest/mail/list',
                {'folder': folder, 'page': page},
                function(data, textStatus, response) {

            if (textStatus == 'success' && response) {
                var total = parseInt(response.getResponseHeader('x-total'));
                var page = parseInt(response.getResponseHeader('x-page'));
                var pageSize = parseInt(response.getResponseHeader('x-page-size'));
                var position = parseInt(response.getResponseHeader('x-position'));

                if (total && total > 0) {
                    listContainer.append(data);

                    pagination.update(page, pageSize, total);

                    setMailListState(true);
                    updateUI();
                } else {
                    Noty.info("No more mails to load.")
                }

                if (!!firstInvoke && total <= 0) {
                    setMailListState(false);
                }
            }
        }).fail(function() {
            Noty.error("Load mail failed, please try it later.")
        })
    }

    function syncMails() {
        var progressDialog = $('#dlgProgress').modal();

        var ajax = $.getJSON("/rest/mail/sync", function(data){
            if (data && data.state === 'ok') {
                if (data.update) {
                    loadMailList();
                } else {
                    Noty.info("No new messages received");
                }
            } else {
                Noty.error("Sync mail failed, please try it later.")
            }
        }).fail(function(xhr) {
            if (xhr.statusText === 'abort') {
                return; // just ignore
            }
            Noty.error("Sync mail failed, please try it later.")
        }).always(function() {
            progressDialog.modal('hide');
            progressDialog.off('hidden.bs.modal');
        });

        progressDialog.on('hidden.bs.modal', function() {
            ajax.abort();
        })
    }

    function openMail(id, callback) {

        var data = {'id' : id};

        callback = callback || function(){};

        $.get('/rest/mail/read', data, function(data, textStatus, response) {
            var state = response.getResponseHeader('x-state');
            var msg = response.getResponseHeader('x-exception') || response.getResponseHeader('x-msg') || '';

            if (state == 'ok' && data) {
                $('#mailViewport .mail-entry').html(data);
                $('.mail-list-item[data-id=' + id +']').removeClass('unread');

                try {
                    callback();
                } catch (e) {}
            } else {
                Noty.error("Open mail failed. " + msg)
            }
        }).fail(function() {
            Noty.error("Open mail failed, please try it later.")
        })
    }

    /**
     * Actions for mail or mails.
     * @param ctrlType (string) could be delete | trash | star | unstar
     */
    function ctrlMail(id, ctrlType, callback) {

        // don't disturb trashing but deleting
        if (ctrlType == 'delete' && !confirm('Are you sure to delete?')) {
            return;
        }

        callback = callback || function(){};

        var params = {};
        params.id = id;
        params.action = ctrlType;

        $.get('/rest/mail/control', params, function(data, textStatus, response) {

            var state = response.getResponseHeader('x-state');
            var msg = response.getResponseHeader('x-exception') || response.getResponseHeader('x-msg') || '';

            if (state == 'ok') {
                try {
                    callback();
                } catch (e) {}
            } else {
                Noty.error(ctrlType + " mail failed. " + msg)
            }
        }).fail(function(){
        })
    }

    function initializeUI() {
        adjustColumnsHeight();

        // reset mail reading area
        $('#mailViewport .mail-entry').empty();

        // update page indicator
        $('.page-indicator').text('0 of 0');

        // hide delete btn
        $('#maillist .toolbar button:has(.fa-trash)').addClass('hidden');

    }

    /**
     * Update buttons and indicators
     */
    function updateUI() {

        // ------------------------- mail list toolbar

        var refreshButton = $('#maillist .toolbar .refresh-btn');
        var removeButton = $('#maillist .toolbar .delete-btn');
        var movetoButton = $('#maillist .toolbar .moveto-btn');

        var haveSelection = $('.mail-list-item.selected').size() > 0;

        refreshButton.toggleClass('hidden', haveSelection);
        removeButton.toggleClass('hidden', !haveSelection);
        movetoButton.toggleClass('hidden', !haveSelection);


        // update the tip of delete button
        if (currentFolder == 'inbox' || currentFolder == 'fav') {
            removeButton.attr('title', 'Move to trash');
        }
        else {
            removeButton.attr('title', 'Delete forever');
        }

        // update 'select-all' button icon
        ;(function(allSelected) {

            var toggleIt = function(btn, toggle) {
                $(btn).find('i.fa').
                        toggleClass('fa-check-square-o', toggle).
                        toggleClass('fa-square-o', !toggle);
            };

            if (arguments.length > 0) {
                toggleIt(this, allSelected);
            }
            else {
                var itemsAll = $('#maillist .mail-list-item');
                var selected = itemsAll.filter('.selected');
                var btn = $('#maillist').find('.select-btn button.select-all-btn')[0];
                toggleIt(btn, itemsAll.size() == selected.size() && itemsAll.size() != 0);
            }
        })();


        // mail view port context toolbar
        ;(function() {
            var selected = $('#maillist .mail-list-item').filter('.active');
            var tb = $('.right-side .toolbar');

            if (selected[0]) {
                tb.find('.delete-btn,.reply').toggleClass('hidden', false);
            } else {
                tb.find('.delete-btn,.reply').toggleClass('hidden', true);
                $('#mailViewport article').empty();
            }
        })();

        // ------------------------- pagination buttons
        if (!pagination.hasPrev()) {
            $('#maillistWrapper .prev-btn').attr('disabled', 'disabled');
            $('#maillist .toolbar .prev-btn').attr('disabled', 'disabled');
        } else {
            $('#maillistWrapper .prev-btn').removeAttr('disabled');
            $('#maillist .toolbar .prev-btn').removeAttr('disabled');
        }
        if (!pagination.hasNext()) {
            $('#maillistWrapper .next-btn').attr('disabled', 'disabled');
            $('#maillist .toolbar .next-btn').attr('disabled', 'disabled');
        } else {
            $('#maillistWrapper .next-btn').removeAttr('disabled');
            $('#maillist .toolbar .next-btn').removeAttr('disabled');
        }

    }

    // actions include favorite and trash and delete
    function bindMailActions() {

        // star or unstar
        $('#maillist').on('click', '.mail-list-item .action-controls .fav-btn', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            var self = this;
            var listItem = $(this).parents('.mail-list-item:first');
            var id = listItem.data('id');
            var was_favorite = $(this).hasClass('fa-star');

            var ctrl = was_favorite ? 'unstar' : 'star';

            ctrlMail(id, ctrl, function() {
                if (was_favorite) {
                    $(self).removeClass('fa-star').addClass('fa-star-o');
                    Noty.success('You un-star it!');
                } else {
                    $(self).removeClass('fa-star-o').addClass('fa-star');
                    Noty.success('You star it!');
                }
            });

            updateUI();
        });

        // delete permanently
        $('#maillist').on('click', '.mail-list-item .action-controls .del-btn', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            if (!confirm('Are you sure to delete?')) {
                return;
            }

            var listItem = $(this).parents('.mail-list-item:first');
            var id = listItem.data('id');

            ctrlMail(id, 'delete', function() {
                listItem.fadeOut(function(){
                    $(this).remove()
                });
                Noty.success('Mail has been deleted forever!');
            });

            updateUI();
        });

        // selection
        $('#maillist').on('click', '.mail-list-item .action-controls :checkbox', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            $(this).parents('.mail-list-item:first').trigger(
                    $(this).is(':checked') ? 'select' : 'unselect')

            updateUI();
        })
    }


    /**
     * Open a mail in the right side.
     */
    function bindMailOpen() {
        $('.mail-list').on('click', '.mail-list-item', function(e){
            // if event source was a checkbox or favorite button
            // or action control panel, ignore it.
            if ($(e.target).is(':checkbox,.fav-btn,.action-controls')) {
                return;
            }

            var offsetX = e.offsetX || e.offsetLeft;

            // skip controls area.
            if (offsetX < 30) {
                return;
            }

            var id = $(this).data('id');

            if (!id) {
                return;
            }

            var self = this;

            openMail(id, function(){
                // change list item state indicator
                $(self).siblings().removeClass('active').end().addClass('active');
                // change url hash
                location.hash = '#/mail/read/' + id;
                updateUI();
            });
        })
    }

    /**
     * Mail list context menu and button event handler.
     */
    function bindMailListMenu() {

        // customize event 'select' and 'unselect', and delegate to #maillist
        $('#maillist').on('select', '.mail-list-item', function() {
            $(this).addClass('selected').find('.action-controls :checkbox').prop('checked', 'checked');
        }).on('unselect', '.mail-list-item', function() {
            $(this).removeClass('selected').find('.action-controls :checkbox:checked').removeAttr('checked');
        });

        //Delete mail or mails async.
        $('#maillist').on('click', '.delete-btn', function(e) {

            var chks = $('.mail-list-item [name=chkSelected]:checked');

            if (chks.size() == 0) {
                return;
            }

            var ids = [];

            chks.each(function() {
                ids[ids.length] = $(this).val();
            })

            var ctrl = currentFolder == 'trash' ? 'delete' : 'trash';

            ctrlMail(ids.join(','), ctrl, function() {
                chks.parents('.mail-list-item').fadeOut(function(){
                    $(this).remove()
                });
            });
        });

        /**
         * Filter mails that if filter return true.
         *
         * @param filter {function}
         * @returns {Array}
         */
        var filterMails = function(filter) {
            var items = [];
            var itemsAll = $('#maillist .mail-list-item');

            // nothing in mail list
            if (itemsAll.size() == 0) {
                return;
            }

            filter = filter || function() {return false};

            itemsAll.each(function() {
                var accept = filter(this);
                if (accept) {
                    items[items.length] = this;
                }
            })

            return items;
        }

        var toggleMailSelection = function(isSelect, filter) {
            var items = filterMails(filter);

            if (items.length == 0) {
                return;
            }

            if (!isSelect) {
                $(items).trigger('unselect')
            } else {
                $(items).trigger('select')
            }

            updateUI();
        }

        // select or un-select all directly
        $('#maillist').on('click', '.select-btn button.select-all-btn', function() {
            var isSelectAll = $(this).find('.fa-square-o').size() > 0;
            toggleMailSelection(isSelectAll, function(mail) {
                return true; // bingo, that means ALL are accepted
            });
        });

        // --------------------- menus
        //select-all-menu
        $('#maillist').on('click', '.select-btn .select-all-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return true;
            });
        });
        //select-none-menu
        $('#maillist').on('click', '.select-btn .select-none-menu', function(e){
            toggleMailSelection(false, function(mail) {
                return true;
            });
        });
        //select-star-menu
        $('#maillist').on('click', '.select-btn .select-star-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return $(mail).find('i.fa-star').size() > 0;
            });
        });
        //select-unstar-menu
        $('#maillist').on('click', '.select-btn .select-unstar-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return $(mail).find('i.fa-star-o').size() > 0;
            });
        });
        $('#maillist').on('click', '.select-btn .select-read-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return !$(mail).hasClass('unread');
            });
        });
        $('#maillist').on('click', '.select-btn .select-unread-menu', function(e){
            toggleMailSelection(true, function(mail) {
                return $(mail).hasClass('unread');
            });
        })


        // --------------------- move-to button

        var MoveSelectedTo = function(folder) {
            if (currentFolder == folder) {
                return;
            }

            var foldersMap = {
                'inbox' : 'untrash',
                'trash' : 'trash'
            }

            var ctrl = foldersMap[folder];

            if (!ctrl) { // incorrect folder, only support these two
                return;
            }

            // get all selected
            var items = filterMails(function(mail){
                return $(mail).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), ctrl, function() {
                loadMailList();
            });
        };

        // move selected mail or mails to <b>INBOX</b> folder.
        $('#maillist').on('click', '.moveto-btn .moveto-inbox-menu', function() {
            MoveSelectedTo('inbox');
        });

        // move selected mail or mails to <b>TRASH</b> folder.
        $('#maillist').on('click', '.moveto-btn .moveto-trash-menu', function() {
            MoveSelectedTo('trash');
        });


        // --------------------- more button

        // mark all that all unread mails in current page as read
        $('#maillist').on('click', '.more-btn .mark-allread-menu', function() {
            // get all unread
            var items = filterMails(function(mail){
                return $(mail).hasClass('unread');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), 'read', function() {
                $(items).removeClass('unread');
            });
        });

        // mark all that selected mails in current page as read
        $('#maillist').on('click', '.more-btn .mark-read-menu', function() {
            // get all selected
            var items = filterMails(function(mail){
                return $(mail).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), 'read', function() {
                $(items).toggleClass('unread', false);
            });
        });

        // mark all that selected mails in current page as unread
        $('#maillist').on('click', '.more-btn .mark-unread-menu', function() {
            // get all selected
            var items = filterMails(function(mail){
                return $(mail).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlMail(ids.join(','), 'unread', function() {
                $(items).toggleClass('unread', true);
            });
        });


        // --------------------- pagination handler

        $('#maillistWrapper').on('click', '.prev-btn', function() {
            loadMailList(currentFolder, pagination.prev());
        });
        $('#maillistWrapper').on('click', '.next-btn', function() {
            loadMailList(currentFolder, pagination.next());
        });
        $('#maillist').on('click', '.toolbar .prev-btn', function() {
            loadMailList(currentFolder, pagination.prev());
        });
        $('#maillist').on('click', '.toolbar .next-btn', function() {
            loadMailList(currentFolder, pagination.next());
        });
    }

    /**
     * To switch mail folder
     */
    function bindFolderSwitch() {
        $('#mainMenu > li').on('click', function(e) {

            var self = this;

            if ($(self).is('.active')) {
                return;
            }

            var folder = $(this).data('name');

            currentFolder = folder;

            $(this).siblings().removeClass('active')
                    .end().addClass('active');

            $('#lblFolderName').text($(self).text());

            pagination.reset();

            loadMailList(folder);
        })
    }

    /**
     * Popup a compose dialog, and ready to send message.
     *
     * All of New and Reply and Forward are using
     * the same compose dialog.
     *
     * @param params {object}
     */
    function openCompose(params) {

        params = $.extend({
            title: 'New mail',
            op: 'new',  // new | reply | reply-all | forward
            to: null,
            cc: null,
            bcc: null,
            subject: null,
            content: null,
            callback: function(){}
        }, params);

        var dialogId = '#dlgCompose';
        var $dlg = $(dialogId);

        var _formatAddress = function(address) {
            if (typeof address == 'string') {
                return address.split(",");
            }
            if (isArray(address)) {
                return address;
            }
            return null;
        };

        // this == dialog
        var handler = function() {
            $(this).find('.modal-title').text(params.title);

            var mc_to = $('#txtTo').magicSuggest();
            var mc_cc = $('#txtCc').magicSuggest();
            var mc_bcc = $('#txtBcc').magicSuggest();

            // reset form {
            mc_to.clear();
            mc_cc.clear();
            mc_bcc.clear();

            $(this).find('[name=subject]').val('');
            $(this).find('[name=content]').val('');

            $(this).find('.group-cc').toggleClass('hidden', true);
            $(this).find('.toggle-btn[data-toggle=".group-cc"] > span').text('Add');
            $(this).find('.group-bcc').toggleClass('hidden', true);
            $(this).find('.toggle-btn[data-toggle=".group-bcc"] > span').text('Add');
            // reset form }

            if (params.to) {
                mc_to.setValue(_formatAddress(params.to));
            }
            if (params.cc) {
                mc_cc.setValue(_formatAddress(params.cc));
                $(this).find('.group-cc').toggleClass('hidden', false); // show it
                $(this).find('.toggle-btn[data-toggle=".group-cc"] > span').text('Remove');
            }
            if (params.bcc) {
                mc_bcc.setValue(_formatAddress(params.bcc));
                $(this).find('.group-bcc').toggleClass('hidden', false); // show it
                $(this).find('.toggle-btn[data-toggle=".group-bcc"] > span').text('Remove');
            }
            if (params.subject) {
                $(this).find('[name=subject]').val(params.subject);
            }
            if (params.content) {
                $(this).find('[name=content]').val(params.content);
            }

            $dlg.modal();
        };

        if (!$dlg.data('initialized')) {
            // update contacts suggestion
            $.get('/rest/contacts.json', {}, function(data, status, xhr) {
                var state = xhr.getResponseHeader("x-state");

                var mcParams = {
                    placeholder: 'Enter recipients...',
                    data: [],
                    valueField: 'email',
                    renderer: function(data){
                        return data.name + ' (<b>' + data.email + '</b>)';
                    },
                    resultAsString: true
                };

                if (state == 'ok') {
                    mcParams.data = data;
                }

                var $dlg = $(dialogId);
                $dlg.find(':text[name=to]').magicSuggest(mcParams);
                $dlg.find(':text[name=cc]').magicSuggest(mcParams);
                $dlg.find(':text[name=bcc]').magicSuggest(mcParams);

                $dlg.data('initialized', true);

                handler.call($dlg[0]);
            }).fail(function(){
                console.error('load contacts suggestion failed.');
            });
            return;
        }

        handler.call($dlg[0]);
    }

    /**
     * initialize compose dialog
     */
    function bindComposeDialog() {
        var dialogId = '#dlgCompose';

        $('.left-side').on('click', '.compose-btn', function(){
            openCompose(); // default as NEW
        });

        // add Bcc & Cc btn event handler
        $(dialogId).on('click', '.toggle-btn', function(){

            var target = $(this).data('toggle');
            var span = $(this).find('span');

            var add = span.text().toLowerCase() == 'add';

            $(target).toggleClass('hidden', !add);
            span.text(add ? 'Remove' : 'Add');

            if (!add) {
                try {
                    // clear Bcc or Cc field
                    $(target).find('.ms-ctn').magicSuggest().clear();
                } catch(e){}
            }

            return false;
        });

        // compose button event handler
        $(dialogId).on('click', '.yes-btn', function(e){
            var $form = $(dialogId).find('form');

            if ($form.find('[name="to[]"]').size() == 0) {
                Noty.error("'To' field is required.");
                return;
            }

            if ($form.find('[name="subject"]').val() == '') {
                Noty.error("'Subject' field is required.");
                return;
            }

            if ($form.find('[name="content"]').val() == '') {
                Noty.error("'Content' field is required.");
                return;
            }

            $(dialogId).modal('hide');
            var $dlgProgress = $('#dlgProgress').modal();

            $.post('/rest/mail/send', $form.serialize(), function(data, status, xhr){
                var state = xhr.getResponseHeader("x-state");
                var msg = xhr.getResponseHeader("x-exception") || xhr.getResponseHeader("x-msg") || '';

                $dlgProgress.modal('hide');

                if (state == 'ok') {
                    try {
                        $('#txtTo').magicSuggest().clear();
                        $('#txtCc').magicSuggest().clear();
                        $('#txtBcc').magicSuggest().clear();

                        $('.group-cc, .group-bcc').addClass('hidden');

                        $form[0].reset();
                    } catch(e) {}

                    Noty.info('Mail send successfully.');
                } else {
                    Noty.error('Failed to send. Please check your input & try it later. ' + (msg));
                }

            }).fail(function(){
                $dlgProgress.modal('hide');
                Noty.error('Failed to send, try it later.');
            });
        });
    }

    /**
     * initialize account settings dialog
     */
    function bindSettingsDialog() {

        var dialogId = '#dlgSetting';

        // Show settings dialog
        $('#tbSystem').on('click', '.settings-btn', function() {

            $.get('/rest/user/settings', {}, function(data, status, xhr) {
                //
                var state = xhr.getResponseHeader("x-state");
                var msg = xhr.getResponseHeader("x-msg") || xhr.getResponseHeader("x-exception") || '';

                if (state == 'ok') {
                    $(dialogId).find('.modal-body').html(data);
                    $(dialogId).modal();
                } else {
                    Noty.error("Can't load setting dialog now. MSG:" + msg);
                }

            }).fail(function(){
                console.error('Failed to load setting dialog.');
            });

        });

        $(dialogId).on('click', '.yes-btn', function() {
            var $form = $(dialogId + ' form');
            var params = $form.serialize();

            $.post('/rest/user/settings', params, function(data, status, xhr){
                var state = xhr.getResponseHeader('x-state');
                var msg = xhr.getResponseHeader("x-msg") || xhr.getResponseHeader("x-exception") || '';

                if ('ok' == state) {
                    $(dialogId).modal('hide');

                    Noty.info("Changes of settings saved.");
                } else {
                    Noty.error("Failed to save. [" + msg + ']');
                }
            });
        })

    }

    function bindMailContextToolbar() {
        var $tb = $('.right-side .toolbar');

        $tb.on('click', '.delete-btn', function(e){
            var $mailInfo = $('.mail-info');
            var mailId = $mailInfo.find('[name=mail_id]').val();
            var ctl = currentFolder == 'trash' ? 'delete' : 'trash';

            ctrlMail(mailId, ctl, function() {
               $('.mail-list-item[data-id=' + mailId + ']').fadeOut(function(){
                   $(this).remove();
                   updateUI();
               });
            });
        });

        // replay directly
        // On {0}, {1} wrote:
        $tb.on('click', '.reply .reply-btn', function(){
            var $mailInfo = $('.mail-info');

            var date = $mailInfo.find('[name=mail_date]').val();
            var mFrom = $mailInfo.find('[name=mail_from]').val();
            var cType = $mailInfo.find('[name=mail_content_type]').val();

            var content = '\r\nOn ' + date + ', ' + mFrom + ' wrote:\r\n';

            if (/^text\/plain/g.test(cType)) {
                content = content + '> ' + $('.mail-body pre').text().replace(/\n/g, '\n> ');
            }
            else if (/^text\/html/g.test(cType)) {
                content = content + '(HTML content will be attached when sent ...)';
            } else {
                content = content + '(content will be attached when sent ...)';
            }

            openCompose({
                title: 'Reply',
                to: $mailInfo.find('[name=mail_from]').val(),
                subject: 'RE:' + $mailInfo.find('[name=mail_subject]').val(),
                content: content
            })
        });
        // replay to all
        $tb.on('click', '.reply .reply-all-menu', function(){
            var $mailInfo = $('.mail-info');

            var date = $mailInfo.find('[name=mail_date]').val();
            var mFrom = $mailInfo.find('[name=mail_from]').val();
            var cType = $mailInfo.find('[name=mail_content_type]').val();

            var content = '\r\nOn ' + date + ', ' + mFrom + ' wrote:\r\n';

            if (/^text\/plain/g.test(cType)) {
                content = content + '> ' + $('.mail-body pre').text().replace(/\n/g, '\n> ');
            }
            else if (/^text\/html/g.test(cType)) {
                content = content + '(HTML content will be attached when sent ...)';
            } else {
                content = content + '(content will be attached when sent ...)';
            }

            openCompose({
                title: 'Reply to all',
                to: $mailInfo.find('[name=mail_from]').val(),
                cc: $mailInfo.find('[name=mail_cc]').val(),
                subject: 'RE:' + $mailInfo.find('[name=mail_subject]').val(),
                content: content
            })
        });
        // forward
        $tb.on('click', '.reply .forward-menu', function(){
            var $mailInfo = $('.mail-info');

            var date = $mailInfo.find('[name=mail_date]').val();
            var mFrom = $mailInfo.find('[name=mail_from]').val();
            var mTo = $mailInfo.find('[name=mail_to]').val();
            var mCc = $mailInfo.find('[name=mail_cc]').val();
            var cType = $mailInfo.find('[name=mail_content_type]').val();
            var subject = $mailInfo.find('[name=mail_subject]').val();

            var content = '\r\n--------- Forwarded message --------\r\n';
            content += 'From: ' + mFrom + '\r\n';
            content += 'Date: ' + date + '\r\n';
            content += 'To: ' + mTo + '\r\n';
            if (mCc) {
                content += 'Cc: ' + mCc + '\r\n';
            }
            content += 'Subject: ' + subject + '\r\n\r\n\r\n\r\n';

            if (/^text\/plain/g.test(cType)) {
                content += $('.mail-body pre').text();
            }
            else if (/^text\/html/g.test(cType)) {
                content += '(HTML content will be attached when sent ...)';
            } else {
                content += '(content will be attached when sent ...)';
            }

            openCompose({
                title: 'Forward',
                subject: 'Fwd:' + $mailInfo.find('[name=mail_subject]').val(),
                content: content
            })
        })
    }

    $(window).resize(function(){
        adjustColumnsHeight();
    });

    // when this page got loaded
    $(function(){

        initializeUI();

        // Synchronize mails
        $('#maillist').on('click', '.refresh-btn', syncMails);

        // Logout the system
        $('#tbSystem').on('click', '.logout-btn', function(){
            if (confirm('Do you really want to leave?')) {
                location.href = '/logout';
            }
        });

        bindFolderSwitch();

        bindMailOpen();

        bindMailListMenu();

        bindMailActions();

        // load profile fragment
        loadProfile();

        // load contacts & init compose dialog
        bindComposeDialog();

        bindSettingsDialog();

        // load mails when page loaded
        loadMailList('inbox', 1, true);

        bindMailContextToolbar();

        updateUI();
    })
</script>

</body>
</html>
