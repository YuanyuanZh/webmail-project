<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Contacts - Web Mail</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- bootstrap 3.0.2 -->
    <link href="/resources/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!--  -->
    <link href="/resources/css/bootstrap.progress-auto.css" rel="stylesheet" type="text/css" />
    <!-- font Awesome -->
    <link href="/resources/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Ionicons -->
    <!--<link href="/resources/css/ionicons.min.css" rel="stylesheet" type="text/css" />-->
    <!-- bootstrap wysihtml5 - text editor -->
    <!--<link href="/resources/css/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" rel="stylesheet" type="text/css" />-->
    <!-- iCheck for checkboxes and radio inputs -->
    <!--<link href="/resources/css/iCheck/minimal/blue.css" rel="stylesheet" type="text/css" />-->
    <!-- Theme style -->
    <link href="/resources/css/mail.css" rel="stylesheet" type="text/css" />

    <link href="/resources/css/mail-resp.css" rel="stylesheet" type="text/css" />

    <link href="/resources/css/contacts.css" rel="stylesheet" type="text/css" />

    <!-- favicon from https://dribbble.com/shots/1297277-Adline-Social-icons-Retouched?list=searches&tag=mail_icon&offset=11 -->
    <link rel="shortcut icon" href="/resources/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/resources/img/favicon.ico" type="image/x-icon">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body class="">


<!-- <div class="header">
  <img  class="" width="120" height="30" src="/resources/img/webmail-logo.png" />

  <button class="btn btn-primary btn-sm pull-right" onclick="location.href='/login.html'">Login</button>
</div> -->

<div class="wrapper">
    <aside class="left-side x-col">
        <div id="profile" class="profile column-header">
            <img src="/resources/img/avatar/avatar_2x.png" height="40" width="40" class="profile-avatar img-circle img-thumbnail" alt="Avatar" />
            <span class="profile-name"></span>

            <!--<div class="profile-dropdown dropdown" >-->
                <!--<span class="glyphicon glyphicon-collapse-down dropdown-trigger" data-toggle="dropdown"></span>-->

                <!--<ul class="dropdown-menu" role="menu">-->
                    <!--<li><a href="#">Foo</a></li>-->
                    <!--<li><a href="#">Bar</a></li>-->
                <!--</ul>-->
            <!--</div>-->
        </div>

        <div class="left-side-tabs">
            <ul class="nav nav-tabs nav-justified">
                <li role="presentation"><a href="/">Mail</a></li>
                <li role="presentation" class="active"><a href="#">Contacts</a></li>
            </ul>
        </div>

        <div style="padding: 1.4em 1em;">
            <button class="btn btn-primary btn-block compose-btn"><i class="fa fa-plus"></i>&nbsp;&nbsp; New</button>
        </div>

        <div style="padding: 0;">
            <ul id="mainMenu" class="nav nav-stacked mail-menu">
                <li data-name="all" class="active"><a href="#"><i class="fa fa-inbox"></i> <span>All</span>
                    <!--<small class="badge pull-right bg-green">192</small>-->
                </a></li>
                <li data-name="starred"><a href="#"><i class="fa fa-star-o"></i> <span>Starred</span></a></li>
                <li data-name="disabled"><a href="#"><i class="fa fa-eye-slash"></i> <span>Disabled</span></a></li>
            </ul>
            <!-- <h5 class="h5">TAGS</h5> -->
        </div>

        <!-- TODO finish this -->
        <!--<div class="toolbar toolbar-bottom">-->
            <!--<div class="btn-group" style="position: absolute; bottom: 1.4em; left: 50%; margin-left: -34px;">-->
                <!--<button class="btn btn-default"><i class="fa fa-power-off"></i></button>-->
                <!--<button class="btn btn-default"><i class="fa fa-cog"></i></button>-->
            <!--</div>-->
        <!--</div>-->

    </aside>

    <!-- Contact list -->
    <aside id="contactlist" class="second-left-side x-col">

        <div class="column-header">
            <div class="search-box pull-right">
                <input placeholder="Search Contact..." type="text" />
                <span class="search-icon"><i class="fa fa-search"></i></span>
            </div>

            <h2 id="lblFolderName" class="folder-name">All</h2>
        </div>

        <header class="toolbar">

            <div class="select-btn btn-group">
                <button class="select-all-btn btn btn-default  btn-sm">
                    <i class="fa fa-square-o"></i>
                </button>
                <button type="button" class="btn btn-default  btn-sm dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li class="select-all-menu"><a href="#">All</a></li>
                    <li class="select-none-menu"><a href="#">None</a></li>
                    <li class="select-star-menu"><a href="#">Starred</a></li>
                    <li class="select-unstar-menu"><a href="#">Unstarred</a></li>
                </ul>
            </div>

            <div class="btn-group">
                <button class="btn btn-default refresh-btn btn-sm"
                        title="Reload the list"><i class="fa fa-refresh"></i></button>
            </div>

            <button type="button" class="btn btn-default delete-btn btn-sm"
                    title="Remove selected"><i class="fa fa-trash"></i></button>
            <button type="button" class="btn btn-default enable-btn btn-sm"
                    title="Enable selected"><i class="fa fa-eye"></i></button>
            <button type="button" class="btn btn-default disable-btn btn-sm"
                    title="Disable selected"><i class="fa fa-eye-slash"></i></button>


            <div class="toolbar-right">
                <small class="page-indicator">1-100 of 1024</small>
                <br/>
                <i class="prev-btn fa fa-chevron-left"></i>&nbsp;&nbsp;&nbsp;
                <i class="next-btn fa fa-chevron-right"></i>

                <!-- <div class="btn-group">
                  <button type="button" class="btn btn-default"><i class="fa fa-chevron-left"></i></button>
                  <button type="button" class="btn btn-default"><i class="fa fa-chevron-right"></i></button>
                </div> -->

            </div>
        </header>

        <div id="contactlistWrapper" data-layout="fill-parent">
            <!-- <div class="toolbar-placeholder"></div> -->
            <dl class="contact-list">

                <!--<dd class="contact-list-item">-->
                    <!--<div class="avatar">-->
                        <!--<img class="" width=50 height=50 src="/resources/img/avatar/tom.png" />-->
                    <!--</div>-->
                    <!--<div class="info">-->
                        <!--<p><strong>Tom Hanks</strong></p>-->
                        <!--<p><i class="fa fa-mobile"></i> (646) 861-2268-->
                            <!--<span class="space"></span><i class="fa fa-envelope-o"></i> tomhanks@yahoo.com</p>-->
                        <!--<p><i class="fa fa-location-arrow"></i> 338 West 23th Street New York, NY 10011, USA</p>-->
                    <!--</div>-->
                    <!--<div class=action-controls>-->
                        <!--<p><input type="checkbox" name="chkSelect" value="" /></p>-->
                        <!--<i class="fa fa-star-o"></i>-->
                    <!--</div>-->
                <!--</dd>-->

            </dl>

            <div>
                <div class="btn-group" style="margin: 0 auto;">
                    <button type="button" class="prev-btn btn btn-default btn-sm"><i class="fa fa-chevron-left"></i></button>
                    <button type="button" class="next-btn btn btn-default btn-sm"><i class="fa fa-chevron-right"></i></button>
                </div>
                <span class="page-indicator">1-100 of 1024</span>
            </div>

        </div>

    </aside>

    <!-- Mail content -->
    <aside class="right-side x-col">

        <div class="column-header">
            <!--<div class="pull-right">-->
                <!--<div class="btn-group">-->
                    <!--<button type="button" class="btn btn-default btn-sm"><i class="fa fa-chevron-left"></i></button>-->
                    <!--<button type="button" class="btn btn-default btn-sm"><i class="fa fa-chevron-right"></i></button>-->
                <!--</div>-->
            <!--</div>-->
            <!--<h2 class="contact-title">Announcing Dedicated Node Services</h2>-->
        </div>

        <header class="toolbar">

            <div class="btn-group">
                <button type="button" class="edit-btn btn btn-default btn-sm"><i class="fa fa-pencil"></i> Edit</button>
                <button type="button" class="enable-btn btn btn-default btn-sm"><i class="fa fa-eye"></i> Enable</button>
                <button type="button" class="disable-btn btn btn-default btn-sm"><i class="fa fa-eye-slash"></i> Disable</button>
                <button type="button" class="delete-btn btn btn-default btn-sm"><i class="fa fa-trash"></i> Delete</button>
            </div>


            <button type="button" class="star-btn btn btn-default btn-sm"><i class="fa fa-star-o"></i></button>
            <button type="button" class="unstar-btn btn btn-default btn-sm"><i class="fa fa-star"></i></button>

            <!--<div class="btn-group">-->
                <!-- <button type="button" class="btn btn-default btn-sm"><i class="fa fa-tag"></i></button> -->
            <!--</div>-->

        </header>

        <div id="viewport" data-layout="fill-parent" style="height: 600px; overflow-y:auto; padding-bottom: 80px;">

            <article class="contact-entry">
                <div class="contact-info hidden">
                    <h3>Tom Hanks</h3>
                    <p><i class="fa fa-envelope-o"></i> <span>openshift-email@redhat.com</span></p>
                </div>

                <hr/>

                <div class="contact-body hidden">

                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label for="" class="col-sm-3 control-label">Full Name</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">Beyoncé Gisselle Knowles</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-3 control-label">Email</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">beyonce@aixmail.com</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-3 control-label">Phone</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">+1 202-456-1111</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-3 control-label">Address</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">
                                    1600 Pennsylvania Ave NW, Washington, DC</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-3 control-label">ZIP Code</label>
                            <div class="col-sm-9">
                                <p class="form-control-static">20500</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-9">
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </div>
                    </form>

                </div><!-- end .contact-body -->

            </article>

        </div>
    </aside>
</div>

<div id="dlgProgress" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <!-- <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span></button> -->
                <h4 class="modal-title" id="myModalLabel">Loading</h4>
            </div>
            <div class="modal-body">
                <div class="progress auto-progress">
                    <div class="progress-bar progress-bar-success progress-bar-striped active"
                         role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                        <span class="sr-only">100% Complete (success)</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
            </div>
        </div>
    </div>
</div>


<div id="dlgEdit" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <!-- <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span></button> -->
                <h4 class="modal-title">Edit contact</h4>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer">
                <button type="button" class="no-btn btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="yes-btn btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="dlgCreate" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog"
     aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">New contact</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="no-btn btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="yes-btn btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>


<script src="/resources/js/jquery-2.1.1.js"></script>
<script src="/resources/js/bootstrap.js"></script>
<script src="/resources/js/underscore-min.js"></script>
<script src="/resources/js/backbone-min.js"></script>
<script src="/resources/js/notify.min.js"></script>
<script src="/resources/js/webmail.js"></script>

<script>

    var currentFolder = 'all';
    var pagination = new Pagination();

    function adjustColumnsHeight() {
        var col_h = $('.left-side').height();

        var calc_offset = function() {
            var tb = $('.toolbar', this);
            var offset = tb.outerHeight() + tb.offset().top;
            return offset;
        }

        $('.x-col:has([data-layout])').each(function(i, n){
            var offset = calc_offset.call(this);
            var _h = col_h - offset;
            $(this).find('[data-layout=fill-parent]').css({"height": _h});
        })
    }

    function loadProfile() {
        var xhr = $.get('/rest/user/profile', function(data, textStatus, response) {

            var state = response.getResponseHeader('x-state');

            if (textStatus == 'success' && state == 'ok') {
                $('#profile').html(data);
            }
        }).fail(function() {
            Noty.error("Load profile failed.")
        })
    }

    function loadContacts(folder, page, firstInvoke) {
        folder = folder || currentFolder || 'all';
        page = page || pagination.page() || '1'; // page 1 as default

        var listContainer = $('#contactlist .contact-list')
        var activeId = listContainer.find('.contact-list-item.active').data('id');
        var offset = listContainer.offset();

        var restoreActive = !activeId ? function(){} : function() {
            listContainer.find('.contact-list-item[data-id=' + activeId + ']')
                    .toggleClass('active', true);

            listContainer.animate({
                scrollTop: offset.top
            }, 400);
        }

        // clean container firstly
        listContainer.empty();

        $.get('/rest/contact/list',
            {'folder': folder, 'page': page},
            function(data, textStatus, response) {

            if (textStatus == 'success' && response) {
                var total = parseInt(response.getResponseHeader('x-total'));
                var page = parseInt(response.getResponseHeader('x-page'));
                var pageSize = parseInt(response.getResponseHeader('x-page-size'));
                var position = parseInt(response.getResponseHeader('x-position'));

                if (total && total > 0) {

                    listContainer.append(data);

                    // restore active state
                    restoreActive();

                    pagination.update(page, pageSize, total);
                } else {
                    pagination.update(1, 15, 0);
                    Noty.info("No more contacts to load.")
                }

                updateUI();

                if (!!firstInvoke && total <= 0) {
//                            setMailListState(false);
                }
            }
        }).fail(function() {
            Noty.error("Load contacts failed, please try it later.")
        })
    }

    // fetch single contact & invoke callback
    function fetchContact(id, callback) {
        callback = callback || function(){};

        var params = {};
        params['id'] = id;

        $.get('/rest/contact/list', params, function(data, status, xhr){
            var state = xhr.getResponseHeader('x-state');
            var msg = xhr.getResponseHeader('x-exception') || xhr.getResponseHeader('x-msg') || '';

            if ('ok' == state) {
                callback(null, data);
            } else {
                Noty.error("Failed to load contact. [" + msg + ']');
            }
        })
    }

    // view contact
    function viewContact(id, callback) {
        var data = {'id' : id};

        callback = callback || function(){};

        $.get('/rest/contact/read', data, function(data, textStatus, response) {
            var state = response.getResponseHeader('x-state');
            var msg = response.getResponseHeader('x-exception') || response.getResponseHeader('x-msg') || '';

            if (state == 'ok' && data) {
                $('#viewport .contact-entry').html(data);

                try {
                    callback();
                } catch (e) {}
            } else {
                Noty.error("Open mail failed. " + msg)
            }
        }).fail(function() {
            Noty.error("Open mail failed, please try it later.")
        })
    }

    function reloadActiveContact() {
        var active = $('.contact-list-item.active');
        var activeId = active.data('id');
        // have active item
        if (active[0]) {
            // refresh contact in contact list
            fetchContact(activeId, function(err, data){
                if (!err) {
                    active.replaceWith(data);
                    $('.contact-list-item').filter('[data-id=' + activeId + ']').toggleClass('active', true);
                    updateUI();
                }
            });

            viewContact(activeId);
        }
    }

    /**
     * Actions for contact or contacts.
     * @param ctrlType (string) could be delete | disable | enable | star | unstar
     */
    function ctrlContact(id, ctrlType, callback) {

        // don't disturb trashing but deleting
        if (ctrlType == 'delete' && !confirm('Are you sure to delete?')) {
            return;
        }

        callback = callback || function(){};

        var params = {};
        params.id = id;
        params.action = ctrlType;

        $.get('/rest/contact/control', params, function(data, textStatus, response) {

            var state = response.getResponseHeader('x-state');
            var msg = response.getResponseHeader('x-exception') || response.getResponseHeader('x-msg') || '';

            if (state == 'ok') {
                try {
                    callback();
                } catch (e) {}
            } else {
                Noty.error(ctrlType + " mail failed. " + msg)
            }
        }).fail(function(){
        })
    }

    function initializeUI() {
        adjustColumnsHeight();

        // reset mail reading area
        $('#viewport .contact-entry').empty();

        // update page indicator
        $('.page-indicator').text('0 of 0');

        // hide trash button
        $('#contactlist .toolbar button:has(.fa-trash)').addClass('hidden');

    }

    /**
     * Update buttons and indicators
     */
    function updateUI() {
        var toolbar = $('#contactlist .toolbar');
        var refreshButton = toolbar.find('.refresh-btn');
        var removeButton = toolbar.find('.delete-btn');
        var enableButton = toolbar.find('.enable-btn');
        var disableButton = toolbar.find('.disable-btn');

        var haveSelection = $('.contact-list-item.selected').size() > 0;

        refreshButton.toggleClass('hidden', haveSelection);
        removeButton.toggleClass('hidden', !haveSelection);
        // no selections or not under 'DISABLED' folder
        enableButton.toggleClass('hidden', !haveSelection || currentFolder != 'disabled');
        // no selections or under 'DISABLED' folder
        disableButton.toggleClass('hidden', !haveSelection || currentFolder == 'disabled');


        // update check-all button state
        ;(function(allSelected) {

            var toggleIt = function(btn, toggle) {
                $(btn).find('i.fa').
                        toggleClass('fa-check-square-o', toggle).
                        toggleClass('fa-square-o', !toggle);
            };

            if (arguments.length > 0) {
                toggleIt(this, allSelected);
            }
            else {
                var itemsAll = $('#contactlist .contact-list-item');
                var selected = itemsAll.filter('.selected');
                var btn = $('#contactlist').find('.select-btn button.select-all-btn')[0];
                toggleIt(btn, itemsAll.size() == selected.size() && itemsAll.size() != 0);
            }
        })();

        // ------------------------- pagination buttons
        if (!pagination.hasPrev()) {
            $('#contactlistWrapper .prev-btn').attr('disabled', 'disabled');
            $('#contactlist .toolbar .prev-btn').attr('disabled', 'disabled');
        } else {
            $('#contactlistWrapper .prev-btn').removeAttr('disabled');
            $('#contactlist .toolbar .prev-btn').removeAttr('disabled');
        }
        if (!pagination.hasNext()) {
            $('#contactlistWrapper .next-btn').attr('disabled', 'disabled');
            $('#contactlist .toolbar .next-btn').attr('disabled', 'disabled');
        } else {
            $('#contactlistWrapper .next-btn').removeAttr('disabled');
            $('#contactlist .toolbar .next-btn').removeAttr('disabled');
        }

        // ------------------------- view context toolbar
        var viewToolbar = $('.right-side .toolbar');
        var activeContact = $('.contact-list-item.active');
        var noActiveContact = activeContact.size() == 0;
        var wasStarred = activeContact[0] && activeContact.find('.fa-star')[0];

        var underDisabledFolder = currentFolder == 'disabled';

        viewToolbar.find('.edit-btn').toggleClass('hidden', noActiveContact);
        viewToolbar.find('.disable-btn').toggleClass('hidden', noActiveContact || underDisabledFolder);
        viewToolbar.find('.enable-btn').toggleClass('hidden', noActiveContact || !underDisabledFolder);
        viewToolbar.find('.delete-btn').toggleClass('hidden', noActiveContact);
        viewToolbar.find('.star-btn').toggleClass('hidden', noActiveContact || !!wasStarred);
        viewToolbar.find('.unstar-btn').toggleClass('hidden', noActiveContact || !wasStarred);

        // clear view port
        if (noActiveContact) {
            $('#viewport > article').empty();
        }
    }

    function bindContactActions() {

        // selection
        $('#contactlist').on('click', '.contact-list-item .action-controls :checkbox', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            $(this).parents('.contact-list-item:first').trigger(
                    $(this).is(':checked') ? 'select' : 'unselect')

            updateUI();
        })

        // star or unstar
        $('#contactlist').on('click', '.contact-list-item .action-controls .fav-btn', function(e){
            if (e.stopPropagation) {
                e.stopPropagation()
            }

            var self = this;
            var listItem = $(this).parents('.contact-list-item:first');
            var id = listItem.data('id');
            var was_favorite = $(this).hasClass('fa-star');

            var ctrl = was_favorite ? 'unstar' : 'star';

            ctrlContact(id, ctrl, function() {
                if (was_favorite) {
                    $(self).removeClass('fa-star').addClass('fa-star-o');
                    Noty.success('You un-star it!');
                } else {
                    $(self).removeClass('fa-star-o').addClass('fa-star');
                    Noty.success('You star it!');
                }
            });

            updateUI();
        });

    }

    function bindContactListToolbar() {

        var $contactList = $('#contactlist');

        // customize event 'select' and 'unselect', and delegate to #maillist
        $contactList.on('select', '.contact-list-item', function() {
            $(this).addClass('selected').find('.action-controls :checkbox').prop('checked', 'checked');
        }).on('unselect', '.contact-list-item', function() {
            $(this).removeClass('selected').find('.action-controls :checkbox:checked').removeAttr('checked');
        });

        $contactList.on('star', '.contact-list-item', function(){
            $(this).find('.action-controls .fav-btn').removeClass('fa-star-o').addClass('fa-star');
        });
        $contactList.on('unstar', '.contact-list-item', function(){
            $(this).find('.action-controls .fav-btn').removeClass('fa-star').addClass('fa-star-o');
        });



        var filterItems = function(filter) {
            var items = [];
            var itemsAll = $('#contactlist .contact-list-item');

            // nothing in mail list
            if (itemsAll.size() == 0) {
                return;
            }

            filter = filter || function() {return false};

            itemsAll.each(function() {
                var accept = filter(this);
                if (accept) {
                    items[items.length] = this;
                }
            })

            return items;
        }

        var toggleItemSelection = function(isSelect, filter) {
            var items = filterItems(filter);

            if (items.length == 0) {
                return;
            }

            if (!isSelect) {
                $(items).trigger('unselect')
            } else {
                $(items).trigger('select')
            }

            updateUI();
        }

        // select or un-select all directly
        $contactList.on('click', '.select-btn button.select-all-btn', function() {
            var isSelectAll = $(this).find('.fa-square-o').size() > 0;
            toggleItemSelection(isSelectAll, function(mail) {
                return true; // bingo, that means ALL are accepted
            });
        });
        //select-all-menu
        $contactList.on('click', '.select-btn .select-all-menu', function(e){
            toggleItemSelection(true, function(mail) {
                return true;
            });
        });
        //select-none-menu
        $contactList.on('click', '.select-btn .select-none-menu', function(e){
            toggleItemSelection(false, function(mail) {
                return true;
            });
        });
        //select-star-menu
        $contactList.on('click', '.select-btn .select-star-menu', function(e){
            toggleItemSelection(true, function(mail) {
                return $(mail).find('i.fa-star').size() > 0;
            });
        });
        //select-unstar-menu
        $contactList.on('click', '.select-btn .select-unstar-menu', function(e){
            toggleItemSelection(true, function(mail) {
                return $(mail).find('i.fa-star-o').size() > 0;
            });
        });

        // toolbar - refresh button
        $contactList.on('click', '.toolbar .refresh-btn', function(e) {
            loadContacts();
        });

        // DELETE can be perform under any folder, this don't like mails.
        $contactList.on('click', '.toolbar .delete-btn', function() {
            // get all selected
            var items = filterItems(function(item){
                return $(item).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlContact(ids.join(','), 'delete', function() {
                loadContacts();
            });
        });

        // ENABLE button.
        $contactList.on('click', '.toolbar .enable-btn', function() {
            // get all selected
            var items = filterItems(function(item){
                return $(item).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlContact(ids.join(','), 'enable', function() {
                loadContacts();
            });
        });

        // DISABLE button.
        $contactList.on('click', '.toolbar .disable-btn', function() {
            // get all selected
            var items = filterItems(function(item){
                return $(item).hasClass('selected');
            });

            if (items.length == 0) {
                return;
            }

            var ids = $(items).map(function(){
                return $(this).data('id')
            }).toArray();

            ctrlContact(ids.join(','), 'disable', function() {
                loadContacts();
            });
        });

        // --------------------- pagination handler

        $('#contactlistWrapper').on('click', '.prev-btn', function() {
            loadContacts(currentFolder, pagination.prev());
        });
        $('#contactlistWrapper').on('click', '.next-btn', function() {
            loadContacts(currentFolder, pagination.next());
        });
        $('#contactlist').on('click', '.toolbar .prev-btn', function() {
            loadContacts(currentFolder, pagination.prev());
        });
        $('#contactlist').on('click', '.toolbar .next-btn', function() {
            loadContacts(currentFolder, pagination.next());
        });
    }

    function bindContactToolbar() {
        var $toolbar = $('.right-side .toolbar');

        $toolbar.on('click', '.edit-btn', function(){
            var active = $('.contact-list-item.active');

            // no active item
            if (!active[0]) {
                return;
            }

            var params = {};
            params['id'] = active.data('id');

            $.get('/rest/contact/edit', params, function(data, status, xhr){
                var state = xhr.getResponseHeader('x-state');
                var msg = xhr.getResponseHeader('x-exception') || xhr.getResponseHeader('x-msg') || '';

                if ('ok' == state) {
                    $('#dlgEdit .modal-body').html(data);
                    $('#dlgEdit').modal();
                } else {
                    Noty.error("Failed to load contact. [" + msg + ']');
                }
            })
        });
        $toolbar.on('click', '.delete-btn', function(){
            var active = $('.contact-list-item.active');

            // no active item
            if (!active[0]) {
                return;
            }

            ctrlContact(active.data('id'), 'delete', function(){
                loadContacts();
            })
        });
        $toolbar.on('click', '.enable-btn', function(){
            var active = $('.contact-list-item.active');

            // no active item
            if (!active[0]) {
                return;
            }

            ctrlContact(active.data('id'), 'enable', function(){
                loadContacts();
            })
        });
        $toolbar.on('click', '.disable-btn', function(){
            var active = $('.contact-list-item.active');

            // no active item
            if (!active[0]) {
                return;
            }

            ctrlContact(active.data('id'), 'disable', function(){
                loadContacts();
            })
        });
        $toolbar.on('click', '.star-btn', function(){
            var active = $('.contact-list-item.active');

            // no active item
            if (!active[0]) {
                return;
            }

            var id = active.data('id');

            ctrlContact(id, 'star', function(){
                active.trigger('star');
                updateUI();
            })
        });
        $toolbar.on('click', '.unstar-btn', function(){
            var active = $('.contact-list-item.active');

            // no active item
            if (!active[0]) {
                return;
            }

            var id = active.data('id');

            ctrlContact(id, 'unstar', function(){
                active.trigger('unstar');
                updateUI();
            })
        });


        // save
        $('#dlgEdit').on('click', '.yes-btn', function() {
            var $form = $('#dlgEdit form');
            var params = $form.serialize();
            var id = $form.find('[name=id]').val();


            $.post('/rest/contact/edit', params, function(data, status, xhr){
                var state = xhr.getResponseHeader('x-state');
                var msg = xhr.getResponseHeader('x-exception') || xhr.getResponseHeader('x-msg') || '';

                if ('ok' == state) {
                    $('#dlgEdit').modal('hide');

                    // refresh active in list & update content view
                    reloadActiveContact();

                    Noty.info("Contact saved.");
                } else {
                    Noty.error("Failed to save contact. [" + msg + ']');
                }
            });
        })
    }

    function bindContactView() {
        $('.contact-list').on('click', '.contact-list-item', function(e){
            // if event source was a checkbox or favorite button
            // or action control panel, ignore it.
            if ($(e.target).is(':checkbox,.fav-btn,.action-controls')) {
                return;
            }

//            var offsetX = e.offsetX || e.offsetLeft;
//
//            // skip controls area.
//            if (offsetX < 30) {
//                return;
//            }

            var id = $(this).data('id');

            if (!id) {
                return;
            }

            var self = this;

            viewContact(id, function(){
                // change list item state indicator
                $(self).siblings().removeClass('active').end().addClass('active');
                // change url hash
                location.hash = '#/contact/view/' + id;
                updateUI();
            });
        })
    }

    // To switch mail folder
    function bindFolderSwitch() {
        $('#mainMenu > li').on('click', function(e) {

            var self = this;

            if ($(self).is('.active')) {
                return;
            }

            var folder = $(this).data('name');

            currentFolder = folder;

            $(this).siblings().removeClass('active')
                    .end().addClass('active');

            $('#lblFolderName').text($(self).text());

            pagination.reset();

            loadContacts(folder);
        })
    }

    function bindContactCreate() {

        var createDialogId = '#dlgCreate';

        $('.left-side').on('click', '.compose-btn', function(){
            $.get('/rest/contact/create', function(data, status, xhr) {
                var state = xhr.getResponseHeader('x-state');
                var msg = xhr.getResponseHeader('x-exception') || xhr.getResponseHeader('x-msg') || '';

                if (state == 'ok') {

                    var dialog = $(createDialogId);

                    dialog.find('.modal-body').html(data);

                    dialog.modal();

                } else {
                    Noty.error('Failed to start creating contact. [' + msg + ']');
                }
            })
        });

        // save
        $(createDialogId).on('click', '.yes-btn', function() {
            var $form = $(createDialogId + ' form');
            var params = $form.serialize();
            var id = $form.find('[name=id]').val();

            if ($form.find('[name=fullName]').val() == '') {
                Noty.error('Full Name is required');
                return;
            }

            if ($form.find('[name=email]').val() == '') {
                Noty.error('Email is required');
                return;
            }

            $.post('/rest/contact/create', params, function(data, status, xhr){
                var state = xhr.getResponseHeader('x-state');
                var msg = xhr.getResponseHeader('x-exception') || xhr.getResponseHeader('x-msg') || '';

                if ('ok' == state) {
                    $(createDialogId).modal('hide');

                    loadContacts();

                    Noty.info("Contact created.");
                } else {
                    Noty.error("Failed to create contact. [" + msg + ']');
                }
            });
        })
    }

    $(window).resize(function(){
        adjustColumnsHeight();
    });

    $(function(){
        initializeUI();

        bindFolderSwitch();

        bindContactListToolbar();

        bindContactActions();

        bindContactToolbar();

        // view single contact by clicking on item in the list
        bindContactView();

        // contact creating button
        bindContactCreate();

        // load profile fragment
        loadProfile();

        // load contact list
        loadContacts('all', 1, true);

        updateUI();
    })
</script>

</body>
</html>